<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>确认收货地址</title>
    <link rel="stylesheet" type="text/css" href="../../css/signsure.css" />
    <link rel="stylesheet" type="text/css" href="../../css/sit.css" />
    <script type="text/javascript" src="../../js/config.js"></script>
    <script type="text/javascript" src="../../js/zepto.min.js"></script>
    <script type="text/javascript" src="../../js/global.js"></script>
</head>
<body>
    <div id="lw-sign-sure" class="lw-sign-sure">
        <ul id="lw-user-address">
            <!-- <li name="sign">
                <span class="gray6">王莉莉</span>
                <span class="gray6">13600001593</span>
                <p>
                    <span class="gray9">黑龙江省</span>
                    <span class="gray9">鸡西市</span>
                    <span class="gray9">密山市</span>
                    <span class="gray9">密山街道</span>
                </p>
                <i class="lw-set" style="display: none;"></i>
            </li>
            <li name="sign">
                <span class="gray6">王莉莉</span>
                <span class="gray6">13600001593</span>
                <p>
                    <span class="gray9">黑龙江省</span>
                    <span class="gray9">鸡西市</span>
                    <span class="gray9">密山市</span>
                    <span class="gray9">密山街道</span>
                </p>
                <i class="lw-set" style="display: none;"></i>
            </li> -->
        </ul>
        <a onclick="plussign(1)" class="lw-plus" href="javascript:;">添加新地址</a>
        <div class="lw-ament">
            <a onclick="amenta1()" class="lw-amenta1" href="javascript:;"><span>修改</span></a>
            <a class="lw-amenta2" href="#" onclick="ok()"><span>确认地址</span></a>
        </div>
        <div class="lw-wrapper" id="lw-shopinfo">
            <!-- <p class="gray6">获得的商品信息</p>
            <div class="lw-goodsword">
                <h6 class="gray6">
                    <a href="#">(第89期)Apple&nbsp;iPhone6s&nbsp;16G&nbsp;颜色随机</a>
                </h6>
                <p class="gray9">价值：￥5688.00</p>
                <p class="gray9">幸运号码：10004075</p>
                <p class="gray9">揭晓时间：2016-07-27 18:14:10</p>
                <a class="lw-goodsimg" href="">
                    <img src="../../image/79349982429501.jpg">
                </a> -->
            </div>
        </div>
    </div>
    <section style="display:none;" id="addsit" class="lw-add-sit">
        <div class="lw-add-wrap">
            <article>
                <dl>添加收货地址</dl>
                <form>
                    <table>
                        <tbody>
                            <tr>
                                <td>
                                    <label>收货人：</label>
                                </td>
                                <td>
                                    <input id="inputname" value="" class="input" type="text" name="">
                                    <em>*</em>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:21%;">
                                    <label>所在地区：</label>
                                </td>
                                <td style="width:80%;">
                                    <select id="s_province" name="s_province">
                                    </select>
                                    <select id="s_city" name="s_city" style="width:45%;">
                                        <option value=""></option>
                                    </select>
                                    <select id="s_county" name="s_county" style="width:92%;">
                                        <option value=""></option>
                                    </select>
                                    <em>*</em>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>街道地址：</label>
                                </td>
                                <td>
                                    <input id="street" class="input" type="text" name="">
                                    <em>*</em>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>手机号码：</label>
                                </td>
                                <td>
                                    <input id="inputphone" class="input" type="text" name="">
                                    <em>*</em>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>收货QQ：</label>
                                </td>
                                <td>
                                    <input id="inputqq" class="input" type="" name="">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>邮政编码：</label>
                                </td>
                                <td>
                                    <input class="input" type="text" name="">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>默认地址：</label>
                                </td>
                                <td>
                                    <input id="deft" class="deft" type="checkbox" checked="checked" name="" value="">
                                    设为默认收货地址
                                </td>
                            </tr>
                            <tr id="addtd">
                                <td colspan="2">
                                    <input id="sitcancel" class="lw-sit-cancel" onclick="plussign(0)" type="button" name="" value="取消" title="取消">
                                    <input id="sitaffirm" class="lw-sit-affirm" onclick="new_save()" type="button" name="submit" value="保存" title="保存">
                                </td>
                            </tr>
                            <tr id="amendtd">
                                <td colspan="2">
                                    <input id="cancelament" class="lw-sit-cancel" onclick="plussign(0)" type="button" name="" value="取消" title="取消">
                                    <input id="affirmament" class="lw-sit-affirm" onclick="edit_save()" type="button" name="submit" value="保存2" title="保存">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </article>
            <script class="resources library" src="../../js/area.js" type="text/javascript"></script>
            <script type="text/javascript">_init_area();</script>
        </div>
    </section>
</body>
<script type="text/javascript">
    var uid = getUrlParam('uid');//获取页面传递过来的uid
    var goods_id = getUrlParam('goods_id');//获取页面传递过来的uid
    var address_id;
    apiready = function(){
        //页面下拉刷新
        api.setRefreshHeaderInfo({
            visible: true,
            bgColor: '#ccc',
            textColor: '#fff',
            textDown: '下拉刷新...',
            textUp: '松开刷新...',
            showTime: true
        }, function(ret, err){
            api.refreshHeaderLoadDone();
        });
    }
        

    $.ajax({
        type: 'post',
        url: AJAX_URI+'/users/load_address_info',
        data: { uid: uid },
        dataType: 'json',
        success: function(result) {
            var html='';
            $(result).each(function(index){
                html+='<li name="sign" onclick="get_address_id('+this.id+')"><span class="gray6">'+this.shouhuoren+'</span>';
                html+='<span class="gray6">'+this.mobile+'</span>';
                html+='<p>';
                html+='<span class="gray9">'+this.sheng+'</span>';
                html+='<span class="gray9">'+this.shi+'</span>';
                html+='<span class="gray9">'+this.xian+'</span>';
                html+='<span class="gray9"'+this.jiedao+'</span></p>';
                html+='<i class="lw-set" style="display: none;"></i></li>';
            });
             $("#lw-user-address").append(html);
        }
    });


    $.ajax({
        type: 'get',
        url: AJAX_URI+'/users/get_win_shopinfo',
        data: { goods_id: goods_id },
        dataType: 'json',
        success: function(result) {
            var html='';
            $(result).each(function(index){
                html+='<p class="gray6">获得的商品信息</p><div class="lw-goodsword">';
                html+='<h6 class="gray6"> <a href="#">(第'+this.qishu+'期)'+this.title+'</a></h6>';
                html+='<p class="gray9">价值：￥'+this.money+'</p>';
                html+='<p class="gray9">幸运号码：'+this.q_user_code+'</p>';
                html+='<p class="gray9">揭晓时间：'+this.q_end_time+'</p>';
                html+='<a class="lw-goodsimg" href="">';
                html+='<img src="http://m.51edb.com/love/uploads/'+this.thumb+'">';
                html+='</a>';
            });
             $("#lw-shopinfo").append(html);
        }
    });

    function plussign(i){
        if (i==1) {
            $('#lw-sign-sure').hide();
            $('#addsit').show();
            $('#amendtd').hide();
            $('#addtd').show();
            $('#inputname').val('');
            $('#inputphone').val('');
            $('#street').val('');
            $('#inputqq').val('');
            $('body').css('background','#fff');
        }else{
            $('#lw-sign-sure').show();
            $('#addsit').hide();
            $('body').css('background','#f7f7f7');
        }
    }

    function amenta1(){
        if(!address_id){
            alert('请选择需要修改的地址');
            return false;
        }
        $.ajax({
            type: 'post',
            url: AJAX_URI+'/users/updata_info',
            data: {
                    address_id: address_id
                },
            dataType: 'json',
            success: function(result) {
                $('#inputname').val(result.shouhuoren);
                $('#inputphone').val(result.mobile);
                $('#street').val(result.jiedao);
                $('#inputqq').val(result.qq);
             /*   alert( JSON.stringify( result ) );*/
            }
        });

        $('#lw-sign-sure').hide();
        $('#addsit').show();
        $('#amendtd').show();
        $('#addtd').hide();

    }

    function get_address_id(id){
        address_id=id;
    }

    //验证表单
    function affirm(){
        var name = $('#inputname').val(); //收货人
        var province = $('#s_province').val();//省
        var s_city = $('#s_city').val();//市
        var s_county = $('#s_county').val();//县
        var street = $('#street').val();//街道
        var phone = $('#inputphone').val();//收货人号码
        var deft = $('#deft').val();//是否为默认
        var qq = $('#inputqq').val();
        var reg = /^0?1[3|4|5|8][0-9]\d{8}$/;
        if (name=='') {
            alert('收货人不能为空');
            return false;
        }else
        if (province=='') {
            alert('请选择有效的省市区');
            return false;
        }
        if (street=='') {
            alert('请填街道地址');
            return false;
        }
        if (phone=='') {
            alert('手机号码不能为空');
            return false;
        }
        if (!reg.test(phone)) {
        alert('请输入正确的手机号');
        return false;
        }

        if(qq!=""){
            var qqis_nun=/^[1-9]+[0-9]*]*$/;
            if (!qqis_nun.test(qq)) {
                alert('请输入有效的QQ');
                return false;
            }
        }

        var hasChk = $('#deft').is(':checked'); // 是否设为默认地址
        if(hasChk){
            var deft=1;
        }else{
            var deft=2;
        }
        var arr =[name,province,s_city,s_county,street,phone,qq,deft];
        return arr;
    }

    function new_save(){
        var arr_info=affirm();
        if(!arr_info[0]){
            return false;
        }
        //添加地址
            $.ajax({
                type: 'post',
                url: AJAX_URI+'/users/add_address',
                data: {
                        uid: uid,//用户ID
                        name: arr_info[0],//收货人
                        province: arr_info[1],//省
                        city: arr_info[2],//市
                        county: arr_info[3],//县
                        street: arr_info[4],//街道
                        phone: arr_info[5],//联系电话
                        qq: arr_info[6],//QQ
                        deft: arr_info[7]//是否设为默认地址 1是 2否
                    },
                dataType: 'json',
                success: function(result) {
                    if(result==1){
                        alert('成功添加地址');
                    }else{
                        alert('添加地址失败');
                    }
                    location.reload();
                }
            });
    }

    function edit_save(){
        var arr_info=affirm();
        if(!arr_info[0]){
            return false;
        }
        //修改地址
        $.ajax({
            type: 'post',
            url: AJAX_URI+'/users/update_user_address',
            data: {
                    address_id: address_id,
                    uid: uid,//用户ID
                    name: arr_info[0],//收货人
                    province: arr_info[1],//省
                    city: arr_info[2],//市
                    county: arr_info[3],//县
                    street: arr_info[4],//街道
                    phone: arr_info[5],//联系电话
                    qq: arr_info[6],//QQ
                    deft: arr_info[7],//是否设为默认地址 1是 2否
                },
            dataType: 'json',
            success: function(result) {
                if(result==1){
                    alert('成功修改地址');
                }else{
                    alert('修改地址失败');
                }
                location.reload();
            }
        });
    }

    //确认收货地址
    function ok(){
        if(!address_id){
            alert('请先选择地址');
            return false;
        }
        $.ajax({
            type: 'post',
            url: AJAX_URI+'/users/ok_address',
            data: {
                    address_id: address_id,
                    goods_id: goods_id,
                    uid: uid,//用户ID
                },
            dataType: 'json',
            success: function(result) {
                if(result==1){
                    alert('确认收货地址成功');
                    window.location.href="../../frame/Framewin.html?uid="+uid;
                }else{
                    alert('确认收货地址失败');
                }

            }
        });
    }

    $("li[name='sign']").live('click', function(){
        $(this).find("i").css('display','block');
        $(this).siblings().find("i").css('display','none');
    })
</script>
</html>